<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ATOMIC FIZZ CAPS ‚Ä¢ Pip‚ÄëBoy 3000</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover" />
    
    <!-- PWA Meta Tags - Enables app-like experience -->
    <meta name="theme-color" content="#00ff41" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Atomic Fizz" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Atomic Fizz Caps" />
    <meta name="msapplication-TileColor" content="#050705" />
    <meta name="msapplication-navbutton-color" content="#00ff41" />
    
    <!-- PWA Manifest - Enables install and hides browser URL bar -->
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/favicon.png" />

    <!-- Content Security Policy to allow external resources -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' https://unpkg.com https://cdn.jsdelivr.net https://www.gstatic.com https://api.phantom.app https://*.phantom.app https://wallet.phantom.app https://*.walletconnect.com https://*.walletconnect.org 'unsafe-inline';
      connect-src 'self' https://unpkg.com https://server.arcgisonline.com https://*.arcgisonline.com https://*.tile.openstreetmap.org https://*.basemaps.cartocdn.com https://atomicfizzcaps.xyz https://www.atomicfizzcaps.xyz https://api.atomicfizzcaps.xyz https://api.mainnet-beta.solana.com https://api.devnet.solana.com https://api.phantom.app https://*.phantom.app https://wallet.phantom.app https://*.walletconnect.com https://*.walletconnect.org https://*.infura.io https://polygon-rpc.com https://mainnet.infura.io wss://api.mainnet-beta.solana.com wss://api.devnet.solana.com wss://*.walletconnect.com wss://*.walletconnect.org;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com;
      img-src 'self' data: https: blob:;
      font-src 'self' https://fonts.gstatic.com data:;
      media-src 'self' data: https:;
      object-src 'none';
      frame-src 'self';
      base-uri 'self';">

    <!-- API base: local dev vs production -->
    <script>
      window.API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.hostname.endsWith('.github.dev'))
        ? 'http://localhost:3001'
        : 'https://api.atomicfizzcaps.xyz';
      // Also set BACKEND_URL for compatibility with existing code
      window.BACKEND_URL = window.API_BASE;
    </script>

    <!-- Leaflet core CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

    <!-- Pip‚ÄëBoy UI CSS -->
    <link rel="stylesheet" href="/css/pipboy.css" />
    <link rel="stylesheet" href="/css/pipboy-map.css" />
    <link rel="stylesheet" href="/css/pipboy-responsive.css" />
    <link rel="stylesheet" href="/css/vats.css" />
    <link rel="stylesheet" href="/css/live-radio.css" />

    <!-- Third-party libs (deferred, non-module globals) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="" defer></script>
    <script src="https://unpkg.com/topojson-client@3" defer></script>

    <!-- Turf UMD (fixes exports is not defined) -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/dist/turf.min.js" defer></script>

    <script src="https://cdn.jsdelivr.net/npm/bs58@5.0.0/dist/bs58.min.js" defer></script>
    
    <!-- WalletConnect for universal wallet support -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js" defer></script>

    <!-- AuthClient must be available before inline wallet code -->
    <script src="/js/authClient.js" defer></script>

    <!-- Vault-Tec Security Module (DevTools Guard) -->
    <script src="/js/modules/devtools-guard.js" defer></script>

    <!-- Web3 Wallet Adapter (universal wallet support) -->
    <script src="/js/modules/web3-wallet-adapter.js" defer></script>
    
    <!-- Live Radio Streaming (Rex the DJ) -->
    <script src="/js/modules/live-radio-streaming.js" defer></script>
    
    <!-- Cross-Chain Bridge Portal -->
    <script src="/js/modules/bridge-portal.js" defer></script>
    
    <!-- Pip‚ÄëBoy SPECIAL system -->
    <script src="/js/pipboy-special.js" defer></script>
    <script src="/js/modules/nft-integration.js" defer></script>

    <!-- Pip‚ÄëBoy styling helper (non-module) -->
    <script src="/js/pipboy/pipboy-style.js" defer></script>

    <style>
      body.pipboy-mode { background:#000; color:#00ffae; }
    </style>
  </head>

  <body class="pipboy-mode">

    <!-- BOOT SCREEN -->
    <div id="bootScreen">
      <pre id="bootText"></pre>
    </div>

    <!-- MAIN PIP-BOY UI -->
    <div id="pipboyScreen" class="hidden">
      <div class="pipboy-root">
        <div class="pipboy-bezel">
          <div class="pipboy-frame">
            <div class="pipboy-crt">

              <!-- CRT overlays -->
              <div class="pipboy-noise"></div>
              <div class="pipboy-scanlines"></div>

              <!-- HEADER -->
              <div class="pipboy-header">
                <div>
                  <span class="pipboy-title">PIP‚ÄëBOY 3000</span>
                  <span class="pipboy-subtitle">ATOMIC FIZZ CAPS</span>
                </div>

                <div class="pipboy-meta">
                  <span class="pipboy-meta-item">STATUS: ONLINE</span>
                </div>

                <!-- WALLET HUD (Phantom only) -->
                <div class="wallet-hud">
                  <span id="walletAddress">WALLET: DISCONNECTED</span>
                  <button id="connectWalletHUD" class="pipboy-button-small">CONNECT</button>
                </div>
              </div>

              <!-- TABS -->
              <div class="pipboy-tabs">
                <button class="pipboy-tab active" data-pipboy-tab="panel-map">MAP</button>
                <button class="pipboy-tab" data-pipboy-tab="panel-stat">STAT</button>
                <button class="pipboy-tab" data-pipboy-tab="panel-items">ITEMS</button>
                <button class="pipboy-tab" data-pipboy-tab="panel-quests">QUESTS</button>
                <button class="pipboy-tab" data-pipboy-tab="panel-radio">RADIO</button>
                <button class="pipboy-tab" data-pipboy-tab="panel-exchange">EXCHANGE</button>
              </div>

              <!-- MAIN PANELS -->
              <div class="pipboy-main">
                <div id="encounterFeed" class="pip-feed"></div>

                <!-- MAP PANEL -->
                <div id="panel-map" class="pipboy-panel active">
                  <div class="panel-header">MAP</div>
                  <div class="panel-body">
                    <div id="mapContainer" class="pipboy-map">
                      <div id="radFlash"></div>
                    </div>

                    <div class="map-overlay">
                      <div class="map-label">WORLD MAP</div>
                      <div class="map-status" id="mapStatus">SCANNING...</div>
                    </div>

                    <div class="map-controls">
                      <button id="exploreToggleBtn" class="pipboy-button-small map-control-btn">üîç EXPLORE MAP</button>
                    </div>

                    <div class="gps-badge" id="gpsBadge">
                      <div id="accDot" class="acc-dot"></div>
                      <div id="accText">GPS: OFFLINE</div>
                    </div>
                  </div>
                </div>

                <!-- STAT PANEL -->
                <div id="panel-stat" class="pipboy-panel">
                  <div class="panel-header">STATUS</div>
                  <div class="panel-body">
                    <div class="panel-row">
                      <span class="label">NAME</span>
                      <span class="value" id="stat-name">WANDERER</span>
                    </div>

                    <div class="panel-row">
                      <span class="label">LEVEL</span>
                      <span class="value" id="stat-level">1</span>
                    </div>

                    <div class="panel-row">
                      <span class="label">XP</span>
                      <span class="value" id="stat-xp">0 / 100</span>
                    </div>

                    <div class="panel-divider"></div>

                    <div class="panel-row">
                      <span class="label">HEALTH</span>
                      <span class="value" id="stat-hp-label">100 / 100</span>
                    </div>
                    <div class="stat-bar">
                      <div class="stat-bar-fill" id="stat-hp-bar"></div>
                    </div>

                    <div class="panel-row">
                      <span class="label">RADIATION</span>
                      <span class="value" id="stat-rad-label">0%</span>
                    </div>
                    <div class="stat-bar stat-bar-rad">
                      <div class="stat-bar-fill" id="stat-rad-bar"></div>
                    </div>

                    <div class="panel-divider"></div>

                    <div class="panel-row">
                      <span class="label">WALLET</span>
                      <span class="value" id="stat-wallet">DISCONNECTED</span>
                    </div>

                    <div class="panel-row">
                      <span class="label">FIZZ CAPS</span>
                      <span class="value" id="stat-caps">0</span>
                    </div>

                    <!-- ATOMIC FIZZ WALLET BLOCK -->
                    <div class="panel-divider"></div>
                    <div id="fizzWalletBlock" style="border:1px solid #00ffae; padding:10px; margin-top:10px;">
                      <div style="font-weight:bold; margin-bottom:6px;">ATOMIC FIZZ WALLET</div>
                      <div>WALLET: <span id="fizzWalletAddress">‚Äî</span></div>
                      <div>CAPS: <span id="fizzWalletCaps">0</span></div>
                      <div>XP: <span id="fizzWalletXP">0</span></div>
                      <div>ITEMS: <span id="fizzWalletItems">0</span></div>
                      <div>NFTS: <span id="fizzWalletNFTs">0</span></div>
                    </div>

                    <div class="panel-divider"></div>

                    <div class="panel-row">
                      <span class="label">WEAPON</span>
                      <span class="value" id="stat-weapon">NONE</span>
                    </div>

                    <div class="panel-row">
                      <span class="label">ARMOR</span>
                      <span class="value" id="stat-armor">NONE</span>
                    </div>

                    <div class="panel-divider"></div>

                    <div class="panel-row">
                      <span class="label">FACTION</span>
                      <span class="value" id="stat-faction">UNALIGNED</span>
                    </div>

                    <div class="panel-row">
                      <span class="label">REPUTATION</span>
                      <span class="value" id="stat-rep">NEUTRAL</span>
                    </div>

                    <div class="panel-row">
                      <span class="label">LOCATION</span>
                      <span class="value" id="stat-location">UNKNOWN</span>
                    </div>

                    <div class="panel-row">
                      <span class="label">WEATHER</span>
                      <span class="value" id="stat-weather">CLEAR</span>
                    </div>

                    <div class="panel-divider"></div>

                    <!-- SPECIAL -->
                    <div class="panel-header" style="margin-top:10px;">SPECIAL</div>

                    <div id="specialBlock">
                      <div class="special-row"><span class="special-label">S</span><span class="special-bar" data-special-key="S"></span><span class="special-value" id="special-S">5</span></div>
                      <div class="special-row"><span class="special-label">P</span><span class="special-bar" data-special-key="P"></span><span class="special-value" id="special-P">5</span></div>
                      <div class="special-row"><span class="special-label">E</span><span class="special-bar" data-special-key="E"></span><span class="special-value" id="special-E">5</span></div>
                      <div class="special-row"><span class="special-label">C</span><span class="special-bar" data-special-key="C"></span><span class="special-value" id="special-C">5</span></div>
                      <div class="special-row"><span class="special-label">I</span><span class="special-bar" data-special-key="I"></span><span class="special-value" id="special-I">5</span></div>
                      <div class="special-row"><span class="special-label">A</span><span class="special-bar" data-special-key="A"></span><span class="special-value" id="special-A">5</span></div>
                      <div class="special-row"><span class="special-label">L</span><span class="special-bar" data-special-key="L"></span><span class="special-value" id="special-L">5</span></div>
                    </div>

                    <div id="respecRow" style="margin-top:10px;">
                      <button id="respecBtn" class="pipboy-button">REBUILD SPECIAL (REQUIRES TOKEN)</button>
                      <div id="respecStatus"></div>
                    </div>

                  </div>
                </div>

                <!-- ITEMS PANEL -->
                <div id="panel-items" class="pipboy-panel">
                  <div class="panel-header">INVENTORY</div>
                  <div class="panel-body" id="inventoryList"></div>
                </div>

                <!-- QUESTS PANEL -->
                <div id="panel-quests" class="pipboy-panel">
                  <div class="panel-header">QUEST</div>
                  <div class="panel-body" id="questBody"></div>
                </div>

                <!-- DIALOG PANEL -->
                <div id="panel-dialog" class="pipboy-panel" style="display:none;">
                  <div class="panel-header">DIALOG</div>
                  <div class="panel-body">
                    <div id="dialogBody" class="dialog-body"></div>
                    <button id="dialogCloseBtn" class="pipboy-button-small" style="margin-top:12px;">CLOSE</button>
                  </div>
                </div>

                <!-- RADIO PANEL -->
                <div id="panel-radio" class="pipboy-panel">
                  <div class="panel-header">RADIO</div>
                  <div class="panel-body">
                    <div id="radioStations">
                      <button class="pipboy-button-small" id="radioCycleBtn">CYCLE STATION</button>
                      <div id="currentStation">NO SIGNAL</div>
                    </div>

                    <div class="panel-divider"></div>

                    <div id="terminalSection" style="display:none;">
                      <div class="panel-header">OVERSEER TERMINAL</div>
                      <button class="pipboy-button" id="openOverseerTerminal">OPEN TERMINAL</button>
                    </div>

                    <div class="panel-divider"></div>

                    <div id="nukeSection">
                      <div class="panel-header" style="color:#ffaa00;">‚ö†Ô∏è NUKE TESTING GROUNDS</div>
                      <div style="padding:10px; background:rgba(255,0,0,0.1); border:1px solid #ff0000; margin:10px 0;">
                        <div style="font-size:0.9em; opacity:0.9;">Destroy unwanted gear for CAPS</div>
                        <div style="font-size:0.8em; margin-top:5px; color:#ff6666;">üîí SYSTEM LOCKED - Awaiting Admin Activation</div>
                      </div>
                      <button class="pipboy-button" id="openNukeTerminal" disabled style="opacity:0.5; cursor:not-allowed;">üîí NUKE (COMING SOON)</button>
                    </div>

                    <div class="panel-divider"></div>

                    <div id="bridgeSection">
                      <div class="panel-header" style="color:#00ffff;">üåÄ WORMHOLE BRIDGE</div>
                      <div style="padding:10px; background:rgba(0,100,255,0.1); border:1px solid #0088ff; margin:10px 0;">
                        <div style="font-size:0.9em; opacity:0.9;">Cross-chain asset portal</div>
                        <div style="font-size:0.8em; margin-top:5px; color:#66bbff;">üîí SYSTEM LOCKED - Awaiting Admin Activation</div>
                      </div>
                      <button class="pipboy-button" id="openBridgeTerminal" disabled style="opacity:0.5; cursor:not-allowed;">üîí BRIDGE (COMING SOON)</button>
                    </div>
                  </div>
                </div>

                <!-- EXCHANGE PANEL -->
                <div id="panel-exchange" class="pipboy-panel">
                  <div class="panel-header">SCAVENGER EXCHANGE</div>
                  <div class="panel-body">
                    <div id="exchangeContent">
                      <p>Trade scavenged items for CAPS and rare gear.</p>
                      <div class="panel-divider"></div>
                      <div id="scavengerItems">
                        <p style="opacity:0.7;">Connect wallet to view exchange options...</p>
                      </div>
                    </div>
                  </div>
                </div>

              </div>

              <!-- FOOTER -->
              <div class="pipboy-footer">
                <div class="footer-left">VAULT‚ÄëTEC INDUSTRIES</div>
                <div class="footer-center">WASTELAND GPS</div>
                <div class="footer-right">REV 77</div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <span id="locations-count" class="hidden"></span>

    <!-- GLOBAL GPS (non-module) -->
    <script src="/js/gps.js" defer></script>

    <!-- CORE GAME ENGINE (plain scripts; correct paths) -->
    <script src="/js/radioPlayer.js" defer></script>
    <script src="/js/main.js" defer></script>

    <!-- GAME MODULES (IIFE scripts attached to window.Game) -->
    <!-- Core Systems -->
    <script src="/js/modules/economy.js" defer></script>
    <script src="/js/modules/mintables.js" defer></script>
    <script src="/js/modules/recipes.js" defer></script>
    <script src="/js/modules/factions.js" defer></script>
    <script src="/js/modules/enemyScaling.js" defer></script>
    
    <!-- Combat & Encounters -->
    <script src="/js/modules/battles.js" defer></script>
    <script src="/js/modules/npcSpawn.js" defer></script>
    <script src="/js/modules/npcEncounter.js" defer></script>
    <script src="/js/modules/npc_signal_runner.js" defer></script>
    
    <!-- Quests & Narrative -->
    <script src="/js/modules/quests.js" defer></script>
    <script src="/js/modules/narrative.js" defer></script>
    
    <!-- Crafting & Collectables -->
    <script src="/js/modules/crafting.js" defer></script>
    <script src="/js/modules/collectables.js" defer></script>

    <!-- WORLD MAP -->
    <script src="/js/modules/worldmap.js" defer></script>
    
    <!-- Map Overlays & Features -->
    <script src="/js/modules/fogOfWar.js" defer></script>
    <script src="/js/modules/weatherOverlay.js" defer></script>
    <script src="/js/modules/radiationZones.js" defer></script>
    <script src="/js/modules/factionOverlay.js" defer></script>
    <script src="/js/modules/questMarker.js" defer></script>
    <script src="/js/modules/trail.js" defer></script>
    <script src="/js/modules/encounterHeatmap.js" defer></script>
    
    <!-- UI Widgets & Helpers -->
    <script src="/js/modules/compass.js" defer></script>
    <script src="/js/modules/lootScanner.js" defer></script>
    <script src="/js/modules/discoveryBanner.js" defer></script>
    <script src="/js/modules/vats.js" defer></script>

    <!-- UI MODULES -->
    <script src="/js/modules/inventory-loader.js" defer></script>
    <script src="/js/modules/inventory-ui.js" defer></script>
    <script src="/js/modules/quest-ui.js" defer></script>
    <script src="/js/modules/struggle-quips.js" defer></script>

    <!-- PIP‚ÄëBOY UI SHELL (non-module) -->
    <script src="/js/pipboy.js" defer></script>

    <!-- BOOT SEQUENCE (non-module) -->
    <script src="/js/boot.js" defer></script>

    <!-- KONAMI CODE EASTER EGG -->
    <script src="/js/konami.js" defer></script>

    <!-- RADIO / OVERSEER POPUP (keeps same behavior) -->
    <script>
      (function () {
        const terminalSection = document.getElementById("terminalSection");
        const btn = document.getElementById("openOverseerTerminal");
        const nukeSection = document.getElementById("nukeSection");
        const nukeBtn = document.getElementById("openNukeTerminal");
        const bridgeSection = document.getElementById("bridgeSection");
        const bridgeBtn = document.getElementById("openBridgeTerminal");

        // Always show terminal section
        if (terminalSection) terminalSection.style.display = "block";
        
        // Nuke and Bridge are always visible but disabled
        // Admin can enable them later via config or wallet check

        function openOverseerPopup() {
          const screenW = window.innerWidth || screen.width;
          const screenH = window.innerHeight || screen.height;

          const width = Math.min(600, Math.max(360, Math.floor(screenW * 0.6)));
          const height = Math.min(800, Math.max(500, Math.floor(screenH * 0.7)));

          const left = Math.floor((screenW - width) / 2);
          const top = Math.floor((screenH - height) / 2);

          const features = [
            "resizable=yes",
            "scrollbars=yes",
            "status=no",
            "toolbar=no",
            "menubar=no",
            "location=no",
            "width=" + width,
            "height=" + height,
            "left=" + left,
            "top=" + top
          ].join(",");

          window.open("/overseer.html", "overseer_terminal", features);
        }

        function openNukePopup() {
          const screenW = window.innerWidth || screen.width;
          const screenH = window.innerHeight || screen.height;

          const width = Math.min(800, Math.max(400, Math.floor(screenW * 0.8)));
          const height = Math.min(900, Math.max(600, Math.floor(screenH * 0.8)));

          const left = Math.floor((screenW - width) / 2);
          const top = Math.floor((screenH - height) / 2);

          const features = [
            "resizable=yes",
            "scrollbars=yes",
            "status=no",
            "toolbar=no",
            "menubar=no",
            "location=no",
            "width=" + width,
            "height=" + height,
            "left=" + left,
            "top=" + top
          ].join(",");

          window.open("/nuke.html", "nuke_terminal", features);
        }

        function openBridgePopup() {
          const screenW = window.innerWidth || screen.width;
          const screenH = window.innerHeight || screen.height;

          const width = Math.min(700, Math.max(400, Math.floor(screenW * 0.7)));
          const height = Math.min(850, Math.max(600, Math.floor(screenH * 0.8)));

          const left = Math.floor((screenW - width) / 2);
          const top = Math.floor((screenH - height) / 2);

          const features = [
            "resizable=yes",
            "scrollbars=yes",
            "status=no",
            "toolbar=no",
            "menubar=no",
            "location=no",
            "width=" + width,
            "height=" + height,
            "left=" + left,
            "top=" + top
          ].join(",");

          window.open("/bridge.html", "bridge_terminal", features);
        }

        if (btn) {
          btn.addEventListener("click", function (e) {
            e.preventDefault();
            openOverseerPopup();
          });
        }

        if (nukeBtn) {
          nukeBtn.addEventListener("click", function (e) {
            e.preventDefault();
            if (nukeBtn.disabled) {
              alert('‚ö†Ô∏è NUKE SYSTEM LOCKED\n\nThe Gear Fusion Chamber is currently disabled.\nAdmin activation required.\n\nComing soon!');
            } else {
              openNukePopup();
            }
          });
        }

        if (bridgeBtn) {
          bridgeBtn.addEventListener("click", function (e) {
            e.preventDefault();
            if (bridgeBtn.disabled) {
              alert('üåÄ WORMHOLE BRIDGE LOCKED\n\nThe cross-chain portal is currently disabled.\nAdmin activation required.\n\nComing soon!');
            } else {
              openBridgePopup();
            }
          });
        }
      })();
    </script>

    <!-- WALLET LOGIN + FIZZ WALLET LOADER (waits for AuthClient) -->
    <script>
      (function waitForAuthClient() {
        function ready() {
          if (typeof AuthClient === 'undefined') {
            return setTimeout(ready, 50);
          }

          const auth = new AuthClient({ apiBase: window.API_BASE });

          const hudBtn = document.getElementById("connectWalletHUD");
          const hudAddress = document.getElementById("walletAddress");

          async function safeJson(res) {
            const text = await res.text();
            try { return JSON.parse(text); } catch (err) {
              console.error("[safeJson] Non-JSON response:", text.slice(0,400));
              throw new Error("Server did not return valid JSON");
            }
          }

          async function updateWalletUI() {
            try {
              if (auth.isAuthenticated && auth.isAuthenticated()) {
                const wallet = auth.getWallet();
                hudAddress.textContent = "WALLET: " + wallet.slice(0, 4) + "..." + wallet.slice(-4);
                if (hudBtn) hudBtn.style.display = "none";

                const apiUrl = (window.API_BASE || "") + "/api/player";
                const res = await auth.authedFetch(apiUrl, { method: "GET" });
                const json = await safeJson(res);

                document.getElementById("stat-wallet").textContent = wallet;
                document.getElementById("stat-caps").textContent = json.caps || 0;
                document.getElementById("fizzWalletAddress").textContent = wallet;
                document.getElementById("fizzWalletCaps").textContent = json.caps || 0;
                document.getElementById("fizzWalletXP").textContent = json.xp || 0;
                document.getElementById("fizzWalletItems").textContent = (json.items && json.items.length) || 0;
                document.getElementById("fizzWalletNFTs").textContent = (json.nfts && json.nfts.length) || 0;
              } else {
                hudAddress.textContent = "WALLET: DISCONNECTED";
                if (hudBtn) hudBtn.style.display = "inline-block";
              }
            } catch (err) {
              console.error("[updateWalletUI] error:", err);
              hudAddress.textContent = "WALLET: DISCONNECTED";
              if (hudBtn) hudBtn.style.display = "inline-block";
            }
          }

          async function connectPhantom() {
            try {
              const provider = window.solana;
              if (!provider || !provider.isPhantom) {
                alert("Phantom Wallet not found.");
                return;
              }
              await provider.connect();
              await auth.login(provider);
              await updateWalletUI();
            } catch (err) {
              console.error(err);
              alert("Wallet login failed: " + (err && err.message ? err.message : err));
            }
          }

          if (hudBtn) hudBtn.addEventListener("click", connectPhantom);
          window.addEventListener("load", () => setTimeout(updateWalletUI, 250));
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', ready);
        } else {
          ready();
        }
      })();
    </script>

    <!-- Service Worker Registration for PWA -->
    <script>
      // Register service worker for PWA functionality
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('[PWA] Service Worker registered:', registration.scope);
            })
            .catch((error) => {
              console.log('[PWA] Service Worker registration failed:', error);
            });
        });
      }
    </script>

  </body>
</html>
