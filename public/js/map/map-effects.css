/* map-effects.css */
/* Fallout CRT Shader â€” curved, glowing, flickering, aberrated, non-blocking */

/* ------------------------------------------------------------
   BASE CONTAINER
------------------------------------------------------------ */
.map-crt {
  position: relative;
  overflow: hidden;
  transform-origin: center center;
  /* subtle curvature */
  transform: perspective(900px) translateZ(0) scale(1.01);
}

/* Curved screen distortion on map content */
.map-crt .leaflet-container {
  transform-origin: center center;
  transform:
    scale(1.02)
    perspective(900px)
    translateZ(0)
    matrix3d(
      1.02, 0,    0,   0,
      0,    1.02, 0,   0,
      0,    0,    1,  -0.0009,
      0,    0,    0,   1
    );
}

/* ------------------------------------------------------------
   SCANLINES
------------------------------------------------------------ */
.map-crt::after {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  background:
    repeating-linear-gradient(
      to bottom,
      rgba(0,255,0,0.04) 0px,
      rgba(0,255,0,0.04) 1px,
      transparent 2px
    );
  mix-blend-mode: overlay;
  opacity: 0.35;
  z-index: 3;
}

/* Scanline flicker */
@keyframes scanline-flicker {
  0%   { opacity: 0.30; }
  20%  { opacity: 0.34; }
  40%  { opacity: 0.28; }
  60%  { opacity: 0.36; }
  80%  { opacity: 0.31; }
  100% { opacity: 0.30; }
}

.map-crt::after {
  animation: scanline-flicker 1.2s infinite steps(2);
}

/* ------------------------------------------------------------
   PHOSPHOR GLOW + GREEN BLOOM
------------------------------------------------------------ */
.map-crt::before {
  content: "";
  position: absolute;
  inset: -10px;
  pointer-events: none;
  background:
    radial-gradient(circle at 50% 50%, rgba(0,255,120,0.24), transparent 65%),
    radial-gradient(circle at 50% 0%, rgba(0,255,0,0.12), transparent 55%),
    radial-gradient(circle at 50% 100%, rgba(0,255,0,0.12), transparent 55%);
  mix-blend-mode: screen;
  opacity: 0.75;
  z-index: 2;
  filter: blur(1.2px);
}

/* ------------------------------------------------------------
   SUBTLE IDLE SHIMMER (replaces constant jitter)
------------------------------------------------------------ */
@keyframes crt-idle {
  0%   { transform: translate(0, 0); }
  50%  { transform: translate(0.15px, -0.15px); }
  100% { transform: translate(0, 0); }
}

.map-crt {
  animation: crt-idle 4s infinite ease-in-out;
}

/* ------------------------------------------------------------
   WARM-UP ANIMATION (trigger once via JS)
------------------------------------------------------------ */
@keyframes crt-warmup {
  0%   { filter: brightness(0.2) blur(3px); transform: scale(1.03); }
  20%  { filter: brightness(0.4) blur(2px); transform: scale(1.02); }
  40%  { filter: brightness(0.6) blur(1.5px); transform: scale(1.01); }
  60%  { filter: brightness(0.8) blur(1px); transform: scale(1.005); }
  80%  { filter: brightness(1) blur(0.5px); transform: scale(1.002); }
  100% { filter: brightness(1) blur(0); transform: scale(1); }
}

.map-crt.warmup {
  animation: crt-warmup 1.4s ease-out;
}

/* ------------------------------------------------------------
   BOOT GLITCH (trigger manually)
------------------------------------------------------------ */
@keyframes crt-glitch {
  0%   { clip-path: inset(0 0 0 0); }
  10%  { clip-path: inset(8% 0 40% 0); transform: translate(-2px, 1px); }
  20%  { clip-path: inset(45% 0 5% 0); transform: translate(2px, -1px); }
  30%  { clip-path: inset(18% 0 50% 0); transform: translate(-1px, 2px); }
  40%  { clip-path: inset(0 0 0 0); transform: translate(0, 0); }
  100% { clip-path: inset(0 0 0 0); transform: translate(0, 0); }
}

.map-crt.boot-glitch {
  animation: crt-glitch 0.35s ease-out;
}

/* ------------------------------------------------------------
   CHROMATIC ABERRATION (RGB split)
------------------------------------------------------------ */
.map-crt .leaflet-container,
.map-crt .leaflet-control,
.map-crt .leaflet-popup-content,
.map-crt .leaflet-tooltip {
  text-shadow:
    -0.6px 0 0 rgba(255,0,0,0.35),
     0.6px 0 0 rgba(0,200,255,0.35);
}

/* ------------------------------------------------------------
   NOISE GRAIN SHADER
------------------------------------------------------------ */
.map-crt .leaflet-map-pane::before {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  background-image:
    url("data:image/svg+xml,%3Csvg viewBox='0 0 160 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.2' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.24'/%3E%3C/svg%3E");
  mix-blend-mode: soft-light;
  opacity: 0.75;
  z-index: 1;
}

/* ------------------------------------------------------------
   MAP GLOW + PIXEL FEEL
------------------------------------------------------------ */
.leaflet-container {
  box-shadow: 0 0 40px rgba(0,255,0,0.28);
  transition: filter 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
}

.leaflet-tile-pane img.leaflet-tile {
  image-rendering: pixelated;
}

/* ------------------------------------------------------------
   ICON TINT BASELINE
------------------------------------------------------------ */
.pip-icon {
  width: 100%;
  height: 100%;
  filter: brightness(0) invert(1);
  opacity: 0.9;
}
